@if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Loading duplicate groups...</p>
  </div>
} @else if (error()) {
  <mat-card class="error-card">
    <mat-card-content>
      <mat-icon color="warn">error</mat-icon>
      <span>{{ error() }}</span>
      <button mat-button color="primary" (click)="loadGroups()">Retry</button>
    </mat-card-content>
  </mat-card>
} @else if (groups().length === 0) {
  <mat-card class="empty-card">
    <mat-card-content>
      <mat-icon>check_circle</mat-icon>
      <h3>No Duplicates Found</h3>
      <p>Your photo collection has no duplicate files.</p>
    </mat-card-content>
  </mat-card>
} @else {
  <div class="table-container">
    <table mat-table [dataSource]="groups()" matSort (matSortChange)="onSortChange($event)">
      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            [checked]="allSelected()"
            [indeterminate]="someSelected()"
            (change)="toggleAllSelection()"
          ></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let group">
          <mat-checkbox
            [checked]="isSelected(group)"
            (change)="toggleSelection(group)"
            (click)="$event.stopPropagation()"
          ></mat-checkbox>
        </td>
      </ng-container>

      <!-- Original (Keep) Column -->
      <ng-container matColumnDef="original">
        <th mat-header-cell *matHeaderCellDef>Original (Keep)</th>
        <td mat-cell *matCellDef="let group" [class]="getRowStatusClass(group)">
          @if (getOriginalFile(group); as original) {
            <div class="original-file">
              <mat-icon class="status-icon">{{ getRowStatusClass(group) === 'status-validated' ? 'check_circle' : (getRowStatusClass(group) === 'status-auto-selected' ? 'auto_fix_high' : 'warning') }}</mat-icon>
              <span class="file-name">{{ original.fileName }}</span>
            </div>
            @if (!isRowExpanded(group.id)) {
              <div class="file-path truncated">{{ getTruncatedPath(original.filePath) }}</div>
            }
          } @else if (hasOriginalSelected(group)) {
            <!-- Original is selected but file details not loaded yet -->
            <div class="original-file">
              <mat-icon class="status-icon">{{ getRowStatusClass(group) === 'status-validated' ? 'check_circle' : 'auto_fix_high' }}</mat-icon>
              <span class="file-name status-text">Original selected</span>
            </div>
            <div class="file-path truncated hint-text">Expand to view details</div>
          } @else {
            <div class="no-original">
              <mat-icon class="status-icon">warning</mat-icon>
              <span class="conflict-text">No original selected</span>
            </div>
          }
        </td>
      </ng-container>

      <!-- Size Column -->
      <ng-container matColumnDef="size">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="size">Size</th>
        <td mat-cell *matCellDef="let group">{{ group.totalSize | fileSize }}</td>
      </ng-container>

      <!-- Date Column -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="date">Date</th>
        <td mat-cell *matCellDef="let group">{{ formatDate(getLatestDate(group)) }}</td>
      </ng-container>

      <!-- Duplicates Column -->
      <ng-container matColumnDef="duplicates">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="fileCount">Duplicates</th>
        <td mat-cell *matCellDef="let group">
          <div class="duplicates-summary">
            <span class="duplicate-count">{{ group.fileCount - 1 }} duplicate{{ (group.fileCount - 1) !== 1 ? 's' : '' }}</span>
            <button
              mat-icon-button
              (click)="toggleRowExpansion(group.id); $event.stopPropagation()"
              matTooltip="{{ isRowExpanded(group.id) ? 'Collapse' : 'Expand' }} file paths"
            >
              <mat-icon>{{ isRowExpanded(group.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
          </div>
          @if (!isRowExpanded(group.id) && getDuplicateFiles(group).length > 0) {
            <div class="duplicate-preview">
              @for (file of getDuplicateFiles(group).slice(0, 2); track file.id) {
                <div class="file-path truncated">
                  <mat-icon>content_copy</mat-icon>
                  {{ getTruncatedPath(file.filePath) }}
                </div>
              }
              @if (getDuplicateFiles(group).length > 2) {
                <div class="more-files">+{{ getDuplicateFiles(group).length - 2 }} more</div>
              }
            </div>
          }
        </td>
      </ng-container>

      <!-- Header Row -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

      <!-- Data Rows -->
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        (click)="groupSelected.emit(row)"
        class="clickable-row"
        [class.expanded]="isRowExpanded(row.id)"
      ></tr>

      <!-- Expanded Row Content -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let group" [attr.colspan]="displayedColumns.length">
          @if (isRowExpanded(group.id)) {
            <div class="expanded-content">
              @if (isLoadingDetails(group.id)) {
                <div class="loading-details">
                  <mat-spinner diameter="24"></mat-spinner>
                  <span>Loading file details...</span>
                </div>
              } @else {
                <div class="expanded-section">
                  <h4>Original File</h4>
                  @if (getOriginalFile(group); as original) {
                    <div class="file-detail">
                      <mat-icon>folder</mat-icon>
                      <span class="full-path">{{ original.filePath }}</span>
                    </div>
                  } @else if (hasOriginalSelected(group)) {
                    <div class="file-detail">
                      <mat-icon>folder</mat-icon>
                      <span class="full-path hint-text">Original file selected (loading details...)</span>
                    </div>
                  } @else {
                    <div class="no-selection-notice">
                      <mat-icon color="warn">warning</mat-icon>
                      <span>No original file selected. Please select one to resolve this duplicate group.</span>
                    </div>
                  }
                </div>

                <div class="expanded-section">
                  <h4>Duplicate Files ({{ group.fileCount - 1 }})</h4>
                  @if (getDuplicateFiles(group).length > 0) {
                    @for (file of getDuplicateFiles(group); track file.id) {
                      <div class="file-detail">
                        <mat-icon>content_copy</mat-icon>
                        <span class="full-path">{{ file.filePath }}</span>
                      </div>
                    }
                  } @else if (!hasLoadedDetails(group.id)) {
                    <div class="file-detail hint-text">
                      <mat-icon>hourglass_empty</mat-icon>
                      <span>Loading file paths...</span>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </td>
      </ng-container>

      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']; when: isExpandedRow"
        class="expanded-row"
      ></tr>
    </table>
  </div>

  <mat-paginator
    [length]="totalItems()"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [pageSizeOptions]="pageSizeOptions"
    (page)="onPageChange($event)"
    showFirstLastButtons
  >
  </mat-paginator>
}
