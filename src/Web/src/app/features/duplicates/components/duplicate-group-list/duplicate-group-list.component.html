@if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Loading duplicate groups...</p>
  </div>
} @else if (error()) {
  <mat-card class="error-card">
    <mat-card-content>
      <mat-icon color="warn">error</mat-icon>
      <span>{{ error() }}</span>
      <button mat-button color="primary" (click)="loadGroups()">Retry</button>
    </mat-card-content>
  </mat-card>
} @else {
  <!-- Filter Bar - always visible when not loading/error -->
  <div class="filter-bar">
    <mat-form-field appearance="outline" class="status-filter">
      <mat-label>Status</mat-label>
      <mat-select [value]="statusFilter()" (selectionChange)="onFilterChange($event.value)">
        @for (option of statusOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.label }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
    <span class="result-count">{{ totalItems() }} groups</span>
  </div>

  @if (groups().length === 0) {
    <mat-card class="empty-card">
      <mat-card-content>
        @if (statusFilter()) {
          <mat-icon>filter_list_off</mat-icon>
          <h3>No Matching Groups</h3>
          <p>No duplicate groups match the selected filter. Try changing the status filter.</p>
        } @else {
          <mat-icon>check_circle</mat-icon>
          <h3>No Duplicates Found</h3>
          <p>Your photo collection has no duplicate files.</p>
        }
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="table-container">
    <table mat-table [dataSource]="groups()" matSort (matSortChange)="onSortChange($event)">
      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            [checked]="allSelected()"
            [indeterminate]="someSelected()"
            (change)="toggleAllSelection()"
          ></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let group">
          <mat-checkbox
            [checked]="isSelected(group)"
            (change)="toggleSelection(group)"
            (click)="$event.stopPropagation()"
          ></mat-checkbox>
        </td>
      </ng-container>

      <!-- Thumbnail Column -->
      <ng-container matColumnDef="thumbnail">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let group">
          <div class="stacked-thumbnails" [class.single]="!hasMultipleFiles(group)">
            <!-- Bottom/back thumbnail (slightly visible behind) -->
            @if (hasMultipleFiles(group)) {
              <img
                [src]="getThumbnailUrl(group, 1)"
                [alt]="'Duplicate file 2'"
                class="thumbnail back"
                loading="lazy"
                (error)="$any($event.target).src = 'assets/placeholder.svg'"
              />
            }
            <!-- Top/front thumbnail -->
            <img
              [src]="getThumbnailUrl(group, 0)"
              [alt]="'Duplicate file 1'"
              class="thumbnail front"
              loading="lazy"
              (error)="$any($event.target).src = 'assets/placeholder.svg'"
            />
          </div>
        </td>
      </ng-container>

      <!-- File Count Column -->
      <ng-container matColumnDef="fileCount">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="fileCount">Files</th>
        <td mat-cell *matCellDef="let group">
          <div class="file-count">
            <mat-icon>content_copy</mat-icon>
            <span>{{ group.fileCount }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Total Size Column -->
      <ng-container matColumnDef="totalSize">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="totalSize">Total Size</th>
        <td mat-cell *matCellDef="let group">{{ group.totalSize | fileSize }}</td>
      </ng-container>

      <!-- Potential Savings Column -->
      <ng-container matColumnDef="potentialSavings">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="potentialSavings">Potential Savings</th>
        <td mat-cell *matCellDef="let group">
          <span class="savings">{{ group.potentialSavings | fileSize }}</span>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="status">Status</th>
        <td mat-cell *matCellDef="let group">
          <mat-chip [class]="getStatusClass(group.status)" highlighted>
            <mat-icon>{{ getStatusIcon(group.status) }}</mat-icon>
            {{ getStatusLabel(group.status) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let group">
          <button
            mat-icon-button
            matTooltip="View Details"
            (click)="viewGroup(group); $event.stopPropagation()"
          >
            <mat-icon>visibility</mat-icon>
          </button>
          @if (group.status === 'Pending' || group.status === 'AutoSelected') {
            <button
              mat-icon-button
              matTooltip="Auto-select Original"
              (click)="autoSelectOriginal(group, $event)"
            >
              <mat-icon>auto_fix_high</mat-icon>
            </button>
          }
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        (click)="viewGroup(row)"
        class="clickable-row"
      ></tr>
    </table>
  </div>

  <mat-paginator
    [length]="totalItems()"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [pageSizeOptions]="[10, 20, 50, 100]"
    (page)="onPageChange($event)"
    showFirstLastButtons
  >
  </mat-paginator>
  }
}
