name: Dev Container CI

on:
  push:
    branches: [main]
    paths:
      - '.devcontainer/**'
      - '.github/workflows/devcontainer.yml'
  pull_request:
    branches: [main]
    paths:
      - '.devcontainer/**'
      - '.github/workflows/devcontainer.yml'
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build & Test Dev Container
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: ci
            path: .devcontainer/ci

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Dev Container (${{ matrix.config.name }})
        uses: devcontainers/ci@v0.3
        with:
          configFile: ${{ matrix.config.path }}/devcontainer.json
          push: never
          runCmd: |
            echo "=== Testing Dev Container (${{ matrix.config.name }}) ==="

            echo "--- .NET SDK ---"
            dotnet --version

            echo "--- Node.js ---"
            node --version
            npm --version

            echo "--- Angular CLI ---"
            ng version

            echo "--- GitHub CLI ---"
            gh --version

            echo "--- Claude Code CLI ---"
            claude --version || echo "Claude CLI installed (version check may require auth)"

            echo "--- Git ---"
            git --version

            echo "--- Environment ---"
            echo "CONTAINER_HOST: ${CONTAINER_HOST:-not set}"
            echo "TRUENAS_HOST: ${TRUENAS_HOST:-not set}"

            echo "=== All checks passed! ==="
