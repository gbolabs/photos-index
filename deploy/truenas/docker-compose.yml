# Photos Index - TrueNAS SCALE Custom App
#
# Deploy via: Apps > Discover Apps > Custom App > Install via YAML
#
# Before deploying:
# 1. Create datasets for PostgreSQL and thumbnails
# 2. Set permissions:
#    sudo chown 70:70 /mnt/<pool>/dbs/photos-index     # PostgreSQL (uid 70)
#    sudo chown 1000:1000 /mnt/<pool>/apps/photos-index # Thumbnails (uid 1000)
# 3. Update volume paths below to match your datasets
# 4. Change the database password!
#
# Access points:
# - Web UI:  http://truenas:8050
# - API:     http://truenas:8050/api/
# - Aspire:  http://truenas:8052
# - Traefik: http://truenas:8054
# - OTLP:    http://truenas:8053 (for Synology indexer)

name: photos-index

services:
  traefik:
    image: traefik:v3.2
    container_name: photos-index-traefik
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "8050:80"
      - "8054:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  postgres:
    image: postgres:16-alpine
    container_name: photos-index-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: photosindex
      POSTGRES_USER: photosindex
      POSTGRES_PASSWORD: changeme
    volumes:
      # UPDATE THIS PATH - PostgreSQL data (chown 70:70)
      - /mnt/hdr1/dbs/photos-index:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U photosindex -d photosindex"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    image: ghcr.io/gbolabs/photos-index/api:${IMAGE_VERSION:-0}
    container_name: photos-index-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_HTTPS_PORTS: ""
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=photosindex;Username=photosindex;Password=changeme"
      ThumbnailDirectory: /data/thumbnails
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://aspire:18889"
      OTEL_SERVICE_NAME: photos-index-api
    volumes:
      # UPDATE THIS PATH - Thumbnails (chown 1000:1000)
      - /mnt/hdr1/apps/photos-index:/data/thumbnails
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.priority=100"
      - "traefik.http.services.api.loadbalancer.server.port=8080"

  web:
    image: ghcr.io/gbolabs/photos-index/web:${IMAGE_VERSION:-0}
    container_name: photos-index-web
    restart: unless-stopped
    depends_on:
      - api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=PathPrefix(`/`)"
      - "traefik.http.routers.web.entrypoints=web"
      - "traefik.http.routers.web.priority=1"
      - "traefik.http.services.web.loadbalancer.server.port=80"

  aspire:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:9.1
    container_name: photos-index-aspire
    restart: unless-stopped
    environment:
      DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS: "true"
    ports:
      # Aspire UI - direct access (doesn't work behind reverse proxy)
      - "8052:18888"
      # OTLP receiver - for Synology indexer telemetry
      - "8053:18889"
