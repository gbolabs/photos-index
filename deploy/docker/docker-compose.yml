# Photos Index - Docker Compose Configuration
#
# Usage:
#   Development (local build): docker compose up -d --build
#   Production (ghcr.io):      docker compose up -d
#
# Set IMAGE_VERSION in .env to use specific release (default: latest)
#
# IMPORTANT: Volume Permissions for Observability Stack
# =====================================================
# The observability containers run as non-root users and need write access
# to their data directories. Before first run, set ownership:
#
#   # Jaeger (user 10001)
#   sudo chown -R 10001:10001 /path/to/jaeger-data
#
#   # Loki (user 10001)
#   sudo chown -R 10001:10001 /path/to/loki-data
#
#   # Grafana (user 472)
#   sudo chown -R 472:472 /path/to/grafana-data
#
# Or use named Docker volumes (default) which handle permissions automatically.

services:
  # ===================================
  # Traefik Reverse Proxy
  # ===================================
  traefik:
    image: traefik:v3.2
    container_name: photos-index-traefik
    command:
      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=${TRAEFIK_DASHBOARD_INSECURE:-true}"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=photos-network"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Redirect HTTP to HTTPS (when SSL enabled)
      # - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      # - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # Let's Encrypt (uncomment for production SSL)
      # - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@example.com}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Logging
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--accesslog=${TRAEFIK_ACCESS_LOG:-false}"
      # OpenTelemetry tracing
      - "--tracing=true"
      - "--tracing.otlp=true"
      - "--tracing.otlp.grpc.endpoint=jaeger:4317"
      - "--tracing.otlp.grpc.insecure=true"
      - "--tracing.serviceName=photos-index-traefik"
      - "--tracing.sampleRate=${TRAEFIK_TRACE_SAMPLE_RATE:-1.0}"
    ports:
      - "${TRAEFIK_HTTP_PORT:-8050}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
      - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - photos-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # Dashboard router via /traefik path
      - "traefik.http.routers.traefik-dashboard.rule=PathPrefix(`/traefik`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard.priority=110"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-strip-prefix"
      - "traefik.http.middlewares.traefik-strip-prefix.stripprefix.prefixes=/traefik"

  # ===================================
  # PostgreSQL Database
  # ===================================
  postgres:
    image: postgres:16-alpine
    container_name: photos-index-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-photosuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-photospass}
      POSTGRES_DB: ${POSTGRES_DB:-photosindex}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-photosuser}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - photos-network
    restart: unless-stopped

  # ===================================
  # RabbitMQ Message Broker
  # ===================================
  rabbitmq:
    image: rabbitmq:4-management-alpine
    container_name: photos-index-rabbitmq
    command: >
      /bin/sh -c "echo '[rabbitmq_management,rabbitmq_prometheus,rabbitmq_opentelemetry].' > /etc/rabbitmq/enabled_plugins && exec docker-entrypoint.sh rabbitmq-server"
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-photos}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-photos}
      # OpenTelemetry configuration
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
      OTEL_SERVICE_NAME: rabbitmq
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - photos-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rabbitmq.rule=PathPrefix(`/rabbitmq`)"
      - "traefik.http.routers.rabbitmq.entrypoints=web"
      - "traefik.http.routers.rabbitmq.priority=110"
      - "traefik.http.routers.rabbitmq.middlewares=rabbitmq-strip-prefix"
      - "traefik.http.middlewares.rabbitmq-strip-prefix.stripprefix.prefixes=/rabbitmq"
      - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"

  # ===================================
  # MinIO Object Storage
  # ===================================
  minio:
    image: minio/minio:latest
    container_name: photos-index-minio
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-http://localhost:8050/minio/}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - photos-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # MinIO Console router
      - "traefik.http.routers.minio-console.rule=PathPrefix(`/minio`)"
      - "traefik.http.routers.minio-console.entrypoints=web"
      - "traefik.http.routers.minio-console.priority=110"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.routers.minio-console.middlewares=minio-strip-prefix"
      - "traefik.http.middlewares.minio-strip-prefix.stripprefix.prefixes=/minio"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"
      # Thumbnails router - direct access to MinIO thumbnails bucket
      - "traefik.http.routers.thumbnails.rule=PathPrefix(`/thumbnails`)"
      - "traefik.http.routers.thumbnails.entrypoints=web"
      - "traefik.http.routers.thumbnails.priority=120"
      - "traefik.http.routers.thumbnails.service=minio-thumbnails"
      # No strip prefix - MinIO path is /thumbnails/thumbs/{hash}.jpg = bucket/key
      # Service configuration for thumbnails
      - "traefik.http.services.minio-thumbnails.loadbalancer.server.port=9000"

  # ===================================
  # Jaeger (Distributed Tracing)
  # ===================================
  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: photos-index-jaeger
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"
      - "${JAEGER_OTLP_PORT:-4317}:4317"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - SPAN_STORAGE_TYPE=badger
      - BADGER_EPHEMERAL=false
      - BADGER_DIRECTORY_VALUE=/badger/data
      - BADGER_DIRECTORY_KEY=/badger/key
      - QUERY_BASE_PATH=/jaeger
    volumes:
      - jaeger_data:/badger
    networks:
      - photos-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jaeger.rule=PathPrefix(`/jaeger`)"
      - "traefik.http.routers.jaeger.entrypoints=web"
      - "traefik.http.routers.jaeger.priority=110"
      - "traefik.http.services.jaeger.loadbalancer.server.port=16686"

  # ===================================
  # Loki (Log Aggregation)
  # ===================================
  loki:
    image: grafana/loki:2.9.0
    container_name: photos-index-loki
    command: -config.file=/etc/loki/config.yaml
    configs:
      - source: loki_config
        target: /etc/loki/config.yaml
    volumes:
      - loki_data:/loki
    networks:
      - photos-network
    restart: unless-stopped

  # ===================================
  # Promtail (Log Collector)
  # ===================================
  promtail:
    image: grafana/promtail:2.9.0
    container_name: photos-index-promtail
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    configs:
      - source: promtail_config
        target: /etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - photos-network
    restart: unless-stopped

  # ===================================
  # Grafana (Unified Dashboard)
  # ===================================
  grafana:
    image: grafana/grafana:latest
    container_name: photos-index-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s:%(http_port)s/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - grafana_data:/var/lib/grafana
    configs:
      - source: grafana_datasources
        target: /etc/grafana/provisioning/datasources/datasources.yml
    depends_on:
      - loki
      - jaeger
    networks:
      - photos-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.routers.grafana.priority=110"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # ===================================
  # Observability Portal (Static HTML)
  # ===================================
  obs-portal:
    image: nginx:alpine
    container_name: photos-index-obs-portal
    configs:
      - source: obs_html
        target: /usr/share/nginx/html/index.html
    networks:
      - photos-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.obs.rule=PathPrefix(`/obs`)"
      - "traefik.http.routers.obs.entrypoints=web"
      - "traefik.http.routers.obs.priority=110"
      - "traefik.http.routers.obs.middlewares=obs-strip-prefix"
      - "traefik.http.middlewares.obs-strip-prefix.stripprefix.prefixes=/obs"
      - "traefik.http.services.obs.loadbalancer.server.port=80"

  # ===================================
  # API Service
  # ===================================
  api:
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/api:${IMAGE_VERSION:-latest}
    build:
      context: ../../
      dockerfile: deploy/docker/api/Dockerfile
    container_name: photos-index-api
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      jaeger:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=${POSTGRES_DB:-photosindex};Username=${POSTGRES_USER:-photosuser};Password=${POSTGRES_PASSWORD:-photospass}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=photos-index-api
      - OTEL_RESOURCE_ATTRIBUTES=service.version=${API_VERSION:-1.0.0}
      # RabbitMQ configuration
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER:-photos}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-photos}
      # MinIO configuration
      - Minio__Endpoint=minio:9000
      - Minio__AccessKey=${MINIO_ROOT_USER:-minioadmin}
      - Minio__SecretKey=${MINIO_ROOT_PASSWORD:-minioadmin}
      - Minio__UseSsl=false
      - Minio__ImagesBucket=images
      - Minio__ThumbnailsBucket=thumbnails
    # Port exposed for direct access (optional - can be removed when using only Traefik)
    ports:
      - "${API_PORT:-5000}:8080"
    networks:
      - photos-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      # Swagger router - handles /api/swagger/* requests
      - "traefik.http.routers.api-swagger.rule=PathPrefix(`/api/swagger`)"
      - "traefik.http.routers.api-swagger.entrypoints=web"
      - "traefik.http.routers.api-swagger.priority=110"
      - "traefik.http.routers.api-swagger.service=api"
      # SignalR hubs router - handles /hubs/* requests (WebSocket)
      - "traefik.http.routers.api-hubs.rule=PathPrefix(`/hubs`)"
      - "traefik.http.routers.api-hubs.entrypoints=web"
      - "traefik.http.routers.api-hubs.priority=105"
      - "traefik.http.routers.api-hubs.service=api"
      # API router - handles /api/* requests
      - "traefik.http.routers.api.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.priority=100"
      # Service configuration
      - "traefik.http.services.api.loadbalancer.server.port=8080"
      # HTTPS router (when SSL enabled)
      # - "traefik.http.routers.api-secure.rule=PathPrefix(`/api`)"
      # - "traefik.http.routers.api-secure.entrypoints=websecure"
      # - "traefik.http.routers.api-secure.tls.certresolver=letsencrypt"
      # - "traefik.http.routers.api-secure.service=api"

  indexing-service:
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/indexing-service:${IMAGE_VERSION:-latest}
    build:
      context: ../../
      dockerfile: deploy/docker/indexing-service/Dockerfile
    container_name: photos-index-indexing
    depends_on:
      api:
        condition: service_healthy
      jaeger:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - API_BASE_URL=http://api:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=photos-index-indexing
      - OTEL_RESOURCE_ATTRIBUTES=service.version=${INDEXING_VERSION:-1.0.0}
      - PHOTOS_DIRECTORY=${PHOTOS_DIRECTORY:-/photos}
      - INDEXING_INTERVAL_MINUTES=${INDEXING_INTERVAL_MINUTES:-60}
      # Disable local processing - handled by distributed services (MetadataService, ThumbnailService)
      - GENERATE_THUMBNAILS=false
      - EXTRACT_METADATA=false
    volumes:
      - ${HOST_PHOTOS_DIRECTORY:-./photos}:/photos:ro
      - indexing_thumbnails:/app/thumbnails
    networks:
      - photos-network
    restart: unless-stopped

  cleaner-service:
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/cleaner-service:${IMAGE_VERSION:-latest}
    build:
      context: ../../
      dockerfile: deploy/docker/cleaner-service/Dockerfile
    container_name: photos-index-cleaner
    depends_on:
      api:
        condition: service_healthy
      postgres:
        condition: service_healthy
      jaeger:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=${POSTGRES_DB:-photosindex};Username=${POSTGRES_USER:-photosuser};Password=${POSTGRES_PASSWORD:-photospass}
      - API_BASE_URL=http://api:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=photos-index-cleaner
      - OTEL_RESOURCE_ATTRIBUTES=service.version=${CLEANER_VERSION:-1.0.0}
      - PHOTOS_DIRECTORY=${PHOTOS_DIRECTORY:-/photos}
      - TRASH_DIRECTORY=${TRASH_DIRECTORY:-/photos/.trash}
      - CLEANER_ENABLED=${CLEANER_ENABLED:-false}
    volumes:
      - ${HOST_PHOTOS_DIRECTORY:-./photos}:/photos
      - cleaner_logs:/app/logs
    networks:
      - photos-network
    restart: unless-stopped

  # ===================================
  # Metadata Service (EXIF extraction)
  # ===================================
  metadata-service:
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/metadata-service:${IMAGE_VERSION:-latest}
    build:
      context: ../../
      dockerfile: deploy/docker/metadata-service/Dockerfile
    container_name: photos-index-metadata
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      jaeger:
        condition: service_started
    environment:
      - DOTNET_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=photos-index-metadata
      - OTEL_RESOURCE_ATTRIBUTES=service.version=${METADATA_VERSION:-1.0.0}
      # RabbitMQ configuration
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER:-photos}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-photos}
      # MinIO configuration
      - Minio__Endpoint=minio:9000
      - Minio__AccessKey=${MINIO_ROOT_USER:-minioadmin}
      - Minio__SecretKey=${MINIO_ROOT_PASSWORD:-minioadmin}
      - Minio__UseSsl=false
      - Minio__ImagesBucket=images
    networks:
      - photos-network
    restart: unless-stopped

  # ===================================
  # Thumbnail Service (Image resizing)
  # ===================================
  thumbnail-service:
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/thumbnail-service:${IMAGE_VERSION:-latest}
    build:
      context: ../../
      dockerfile: deploy/docker/thumbnail-service/Dockerfile
    container_name: photos-index-thumbnail
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      jaeger:
        condition: service_started
    environment:
      - DOTNET_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=photos-index-thumbnail
      - OTEL_RESOURCE_ATTRIBUTES=service.version=${THUMBNAIL_VERSION:-1.0.0}
      # RabbitMQ configuration
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=${RABBITMQ_USER:-photos}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-photos}
      # MinIO configuration
      - Minio__Endpoint=minio:9000
      - Minio__AccessKey=${MINIO_ROOT_USER:-minioadmin}
      - Minio__SecretKey=${MINIO_ROOT_PASSWORD:-minioadmin}
      - Minio__UseSsl=false
      - Minio__ImagesBucket=images
      - Minio__ThumbnailsBucket=thumbnails
    networks:
      - photos-network
    restart: unless-stopped

  # ===================================
  # Web Interface (Angular + nginx)
  # ===================================
  web:
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/web:${IMAGE_VERSION:-latest}
    build:
      context: ../../
      dockerfile: deploy/docker/web/Dockerfile
    container_name: photos-index-web
    depends_on:
      - api
    environment:
      # API URL for Angular app - now relative since Traefik handles routing
      - API_URL=${API_URL:-/api}
      - NGINX_PORT=80
    # Port exposed for direct access (optional - can be removed when using only Traefik)
    ports:
      - "${WEB_PORT:-4200}:80"
    networks:
      - photos-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # Web router - handles all requests except /api/*
      - "traefik.http.routers.web.rule=PathPrefix(`/`)"
      - "traefik.http.routers.web.entrypoints=web"
      - "traefik.http.routers.web.priority=1"
      # Service configuration
      - "traefik.http.services.web.loadbalancer.server.port=80"
      # HTTPS router (when SSL enabled)
      # - "traefik.http.routers.web-secure.rule=PathPrefix(`/`)"
      # - "traefik.http.routers.web-secure.entrypoints=websecure"
      # - "traefik.http.routers.web-secure.tls.certresolver=letsencrypt"
      # - "traefik.http.routers.web-secure.priority=1"

configs:
  loki_config:
    content: |
      auth_enabled: false
      server:
        http_listen_port: 3100
        grpc_listen_port: 9096
      common:
        instance_addr: 127.0.0.1
        path_prefix: /loki
        storage:
          filesystem:
            chunks_directory: /loki/chunks
            rules_directory: /loki/rules
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory
      query_range:
        results_cache:
          cache:
            embedded_cache:
              enabled: true
              max_size_mb: 100
      limits_config:
        volume_enabled: true
      schema_config:
        configs:
          - from: 2020-10-24
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: index_
              period: 24h

  promtail_config:
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0
      positions:
        filename: /tmp/positions.yaml
      clients:
        - url: http://loki:3100/loki/api/v1/push
      scrape_configs:
        - job_name: docker
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
          relabel_configs:
            - source_labels: ['__meta_docker_container_name']
              regex: '/(.*)'
              target_label: 'container'
            - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
              target_label: 'service'

  grafana_datasources:
    content: |
      apiVersion: 1
      datasources:
        - name: Jaeger
          type: jaeger
          uid: jaeger
          url: http://jaeger:16686
          access: proxy
          isDefault: false
        - name: Loki
          type: loki
          uid: loki
          url: http://loki:3100
          access: proxy
          isDefault: true
          jsonData:
            derivedFields:
              - name: TraceID
                matcherRegex: '"traceId":"([a-f0-9]+)"'
                url: '$${__value.raw}'
                datasourceUid: jaeger

  obs_html:
    content: |
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Photos Index - Observability Portal</title>
          <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                  min-height: 100vh;
                  color: #fff;
                  padding: 2rem;
              }
              .container { max-width: 1200px; margin: 0 auto; }
              h1 {
                  text-align: center;
                  margin-bottom: 0.5rem;
                  font-size: 2.5rem;
                  background: linear-gradient(90deg, #00d4ff, #7b2cbf);
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
              }
              .subtitle {
                  text-align: center;
                  color: #888;
                  margin-bottom: 3rem;
              }
              .grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                  gap: 1.5rem;
              }
              .card {
                  background: rgba(255,255,255,0.05);
                  border: 1px solid rgba(255,255,255,0.1);
                  border-radius: 16px;
                  padding: 1.5rem;
                  transition: transform 0.2s, box-shadow 0.2s;
                  text-decoration: none;
                  color: inherit;
                  display: block;
              }
              .card:hover {
                  transform: translateY(-4px);
                  box-shadow: 0 12px 40px rgba(0,0,0,0.3);
                  border-color: rgba(255,255,255,0.2);
              }
              .card-header {
                  display: flex;
                  align-items: center;
                  gap: 1rem;
                  margin-bottom: 1rem;
              }
              .card-icon {
                  width: 48px;
                  height: 48px;
                  border-radius: 12px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 1.5rem;
              }
              .card-title { font-size: 1.25rem; font-weight: 600; }
              .card-desc { color: #aaa; font-size: 0.9rem; line-height: 1.5; }
              .card-port {
                  margin-top: 1rem;
                  padding-top: 1rem;
                  border-top: 1px solid rgba(255,255,255,0.1);
                  font-family: monospace;
                  font-size: 0.85rem;
                  color: #666;
              }
              .grafana .card-icon { background: linear-gradient(135deg, #f46800, #f9b233); }
              .jaeger .card-icon { background: linear-gradient(135deg, #00bcd4, #0097a7); }
              .rabbitmq .card-icon { background: linear-gradient(135deg, #ff6600, #ff8533); }
              .minio .card-icon { background: linear-gradient(135deg, #c72c48, #e91e63); }
              .traefik .card-icon { background: linear-gradient(135deg, #37abc8, #2196f3); }
              .app .card-icon { background: linear-gradient(135deg, #7b2cbf, #9c27b0); }
              .section-title {
                  font-size: 0.9rem;
                  text-transform: uppercase;
                  letter-spacing: 2px;
                  color: #666;
                  margin: 2rem 0 1rem;
              }
              .status {
                  display: inline-block;
                  width: 8px;
                  height: 8px;
                  border-radius: 50%;
                  background: #4caf50;
                  margin-right: 0.5rem;
                  animation: pulse 2s infinite;
              }
              @keyframes pulse {
                  0%, 100% { opacity: 1; }
                  50% { opacity: 0.5; }
              }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>Photos Index</h1>
              <p class="subtitle">Observability Portal</p>

              <div class="section-title"><span class="status"></span>Observability</div>
              <div class="grid">
                  <a href="/grafana/" class="card grafana">
                      <div class="card-header">
                          <div class="card-icon">üìä</div>
                          <div class="card-title">Grafana</div>
                      </div>
                      <div class="card-desc">Unified dashboard for logs and traces. Query Loki for logs, Jaeger for traces.</div>
                      <div class="card-port">:3000</div>
                  </a>
                  <a href="/jaeger/" class="card jaeger">
                      <div class="card-header">
                          <div class="card-icon">üîç</div>
                          <div class="card-title">Jaeger</div>
                      </div>
                      <div class="card-desc">Distributed tracing. View request flows across services, analyze latencies.</div>
                      <div class="card-port">:16686</div>
                  </a>
              </div>

              <div class="section-title"><span class="status"></span>Infrastructure</div>
              <div class="grid">
                  <a href="/rabbitmq/" class="card rabbitmq">
                      <div class="card-header">
                          <div class="card-icon">üê∞</div>
                          <div class="card-title">RabbitMQ</div>
                      </div>
                      <div class="card-desc">Message broker management. Monitor queues, exchanges, and connections.</div>
                      <div class="card-port">:15672</div>
                  </a>
                  <a href="/minio/" class="card minio">
                      <div class="card-header">
                          <div class="card-icon">ü™£</div>
                          <div class="card-title">MinIO</div>
                      </div>
                      <div class="card-desc">Object storage console. Browse buckets, manage files and policies.</div>
                      <div class="card-port">:9001</div>
                  </a>
                  <a href="/traefik/" class="card traefik">
                      <div class="card-header">
                          <div class="card-icon">üîÄ</div>
                          <div class="card-title">Traefik</div>
                      </div>
                      <div class="card-desc">Reverse proxy dashboard. View routes, services, and middleware.</div>
                      <div class="card-port">:8080</div>
                  </a>
              </div>

              <div class="section-title"><span class="status"></span>Application</div>
              <div class="grid">
                  <a href="/" class="card app">
                      <div class="card-header">
                          <div class="card-icon">üì∑</div>
                          <div class="card-title">Photos Index</div>
                      </div>
                      <div class="card-desc">Main application. Browse photos, manage duplicates, view metadata.</div>
                      <div class="card-port">:8050</div>
                  </a>
                  <a href="/api/swagger" class="card app">
                      <div class="card-header">
                          <div class="card-icon">üìö</div>
                          <div class="card-title">API Docs</div>
                      </div>
                      <div class="card-desc">Swagger/OpenAPI documentation. Explore and test API endpoints.</div>
                      <div class="card-port">/api/swagger</div>
                  </a>
              </div>
          </div>
      </body>
      </html>

volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  minio_data:
    driver: local
  indexing_thumbnails:
    driver: local
  cleaner_logs:
    driver: local
  traefik_letsencrypt:
    driver: local
  jaeger_data:
    driver: local
  loki_data:
    driver: local
  grafana_data:
    driver: local

networks:
  photos-network:
    driver: bridge
