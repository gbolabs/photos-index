# Photos Index - Synology NAS Docker Compose Override
#
# This file provides Synology-specific overrides for deployment on Synology NAS.
# Usage: docker compose -f docker-compose.yml -f docker-compose.synology.yml up -d
#
# For the cleaner service to work (if enabled), you need read-write access.
# Keep CLEANER_ENABLED=false in .env until you've verified duplicate detection works.

services:
  # ===================================
  # PostgreSQL - Use Synology volume path
  # ===================================
  postgres:
    volumes:
      # Store database in a dedicated folder on Synology volume
      # Adjust volume number as needed (volume1, volume2, etc.)
      - /volume1/docker/photos-index/postgres:/var/lib/postgresql/data
    # Resource limits for NAS
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ===================================
  # Aspire Dashboard - Reduce memory footprint
  # ===================================
  aspire-dashboard:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ===================================
  # API Service
  # ===================================
  api:
    # Pre-built image from GitHub Container Registry
    # Version is set via IMAGE_VERSION in .env (default: latest)
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/api:${IMAGE_VERSION:-latest}
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ===================================
  # Indexing Service - Read-only access to photos
  # ===================================
  indexing-service:
    # Pre-built image from GitHub Container Registry
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/indexing-service:${IMAGE_VERSION:-latest}
    volumes:
      # Photos directory - READ-ONLY for safety
      - ${HOST_PHOTOS_DIRECTORY:-/volume1/photo}:/photos:ro
      # Thumbnails - Use Synology volume
      - /volume1/docker/photos-index/thumbnails:/app/thumbnails
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ===================================
  # Cleaner Service - Disabled by default
  # ===================================
  cleaner-service:
    # Pre-built image from GitHub Container Registry
    # Keep disabled until duplicates are verified (set CLEANER_ENABLED=true in .env when ready)
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/cleaner-service:${IMAGE_VERSION:-latest}
    volumes:
      # Photos directory - REQUIRES WRITE ACCESS for deletion
      - ${HOST_PHOTOS_DIRECTORY:-/volume1/photo}:/photos
      # Cleaner logs - Use Synology volume
      - /volume1/docker/photos-index/cleaner-logs:/app/logs
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ===================================
  # Web Interface
  # ===================================
  web:
    # Pre-built image from GitHub Container Registry
    image: ${IMAGE_REGISTRY:-ghcr.io/gbolabs/photos-index}/web:${IMAGE_VERSION:-latest}
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # ===================================
  # Traefik - Reduce resource usage
  # ===================================
  traefik:
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Store Let's Encrypt certs on Synology volume
      - /volume1/docker/photos-index/traefik:/letsencrypt
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

# Override volume definitions to use Synology paths
volumes:
  postgres_data:
    driver_opts:
      type: none
      device: /volume1/docker/photos-index/postgres
      o: bind
  indexing_thumbnails:
    driver_opts:
      type: none
      device: /volume1/docker/photos-index/thumbnails
      o: bind
  cleaner_logs:
    driver_opts:
      type: none
      device: /volume1/docker/photos-index/cleaner-logs
      o: bind
  traefik_letsencrypt:
    driver_opts:
      type: none
      device: /volume1/docker/photos-index/traefik
      o: bind
