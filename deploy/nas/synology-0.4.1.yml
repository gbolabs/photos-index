# Photos Index v0.4.1 - Synology NAS (Indexer Only)
#
# This runs ONLY the indexer on Synology. All other services run on TrueNAS.
# The indexer connects to TrueNAS API via SignalR for bidirectional communication.
#
# IMPORTANT:
# - Scan directories are configured via the TrueNAS web UI, NOT here
# - The paths configured in TrueNAS must match the volume mounts below
# - Excluded directories (@eaDir, #recycle, etc.) are built into the indexer
#
# Usage:
#   docker compose -f synology-0.4.1.yml up -d

name: photos-index-indexer

services:
  indexer:
    container_name: photos-index-indexer
    image: ghcr.io/gbolabs/photos-index/indexing-service:0.4.1
    restart: unless-stopped
    extra_hosts:
      - "tn.isago.ch:192.168.114.31"
    environment:
      # API connection (TrueNAS) - HTTPS on port 8053
      API_BASE_URL: https://tn.isago.ch:8053

      # Distributed mode - don't process locally, send to TrueNAS
      EXTRACT_METADATA: "false"
      GENERATE_THUMBNAILS: "false"

      # OpenTelemetry - send traces to TrueNAS Jaeger
      OTEL_EXPORTER_OTLP_ENDPOINT: http://192.168.114.31:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_SERVICE_NAME: photos-index-indexer-synology

    volumes:
      # Mount photo directories - READ-ONLY for safety
      # These paths must match what's configured in TrueNAS scan directories
      - /volume1/Public:/nas/public:ro
      - /volume1/photo:/nas/photo:ro
      - /volume1/Photos:/nas/photos:ro

    # Note: CPU limits removed - Synology kernel doesn't support CFS scheduler
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "https://tn.isago.ch:8053/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
