# Photos Index - Synology Indexer Only
#
# This deployment runs ONLY the indexing service on Synology.
# All other services (API, Database, Web UI) run on TrueNAS.
#
# Prerequisites:
# - TrueNAS deployment is running and accessible
# - API endpoint is reachable from Synology
#
# Usage:
#   1. Copy this file and .env.example to your Synology
#   2. cp .env.example .env
#   3. Edit .env with your TrueNAS IP and photo paths
#   4. Run: docker compose up -d
#
# Note: Synology doesn't support 'deploy' resource limits - don't add them

services:
  indexer:
    image: ghcr.io/gbolabs/photos-index/indexing-service:${IMAGE_VERSION:-0.0.1}
    container_name: photos-indexer
    restart: unless-stopped

    # Run as root to read all files (safe - volumes are read-only)
    user: "0:0"

    environment:
      # Required: TrueNAS API endpoint (via Traefik)
      # IMPORTANT: Use API_BASE_URL, not API_URL
      - API_BASE_URL=${API_BASE_URL:-http://truenas.local:8050/api}

      # Directories to scan (comma-separated, maps to container paths)
      - SCAN_DIRECTORIES=/photos

      # Scan interval in minutes (default: 60)
      - SCAN_INTERVAL_MINUTES=${SCAN_INTERVAL_MINUTES:-60}

      # Logging level
      - LOG_LEVEL=${LOG_LEVEL:-Information}

      # OpenTelemetry - send traces to TrueNAS Aspire
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_ENDPOINT:-}
      - OTEL_SERVICE_NAME=photos-index-indexer-synology

      # Resource limits for Synology
      - DOTNET_GCHeapHardLimit=200000000

    volumes:
      # Mount your photo directories (read-only for safety)
      # Add more volumes as needed for different photo locations
      - ${PHOTOS_PATH:-/volume1/photos}:/photos:ro

      # Optional: Additional photo directories
      # - /volume1/backup/photos:/photos-backup:ro
      # - /volume2/camera:/camera:ro

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
