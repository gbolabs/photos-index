# Photos Index - Podman Kube Play manifest
# Usage: podman kube play photos-index.yaml
# Stop:  podman kube play --down photos-index.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: photos-index-config
data:
  ASPNETCORE_ENVIRONMENT: "Development"
  POSTGRES_USER: "photosuser"
  POSTGRES_DB: "photosindex"
  RABBITMQ_USER: "photos"
  MINIO_ROOT_USER: "minioadmin"
  # In a pod, all containers share localhost
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://localhost:4317"
  OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
  API_BASE_URL: "http://localhost:5080"
  RABBITMQ_HOST: "localhost"
  RABBITMQ_PORT: "5672"
  MINIO_ENDPOINT: "localhost:9000"
  INDEXING_INTERVAL_MINUTES: "5"
  CLEANER_ENABLED: "false"
---
apiVersion: v1
kind: Secret
metadata:
  name: photos-index-secrets
stringData:
  POSTGRES_PASSWORD: "photospass"
  RABBITMQ_PASSWORD: "photos"
  MINIO_ROOT_PASSWORD: "minioadmin"
---
apiVersion: v1
kind: Pod
metadata:
  name: photos-index
  labels:
    app: photos-index
spec:
  restartPolicy: Never
  containers:
    # Traefik Reverse Proxy - Single entry point
    - name: traefik
      image: docker.io/library/traefik:v3.2
      ports:
        # Use 8080 for HTTP (rootless Podman can't bind to port 80)
        - containerPort: 8080
          hostPort: 8080
        # Traefik dashboard
        - containerPort: 8081
          hostPort: 8081
      args:
        - "--configFile=/etc/traefik/traefik.yml"
      volumeMounts:
        - name: traefik-config
          mountPath: /etc/traefik

    # PostgreSQL Database
    - name: postgres
      image: docker.io/library/postgres:16-alpine
      ports:
        - containerPort: 5432
          hostPort: 5432
      env:
        - name: POSTGRES_USER
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: POSTGRES_USER
        - name: POSTGRES_DB
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: POSTGRES_DB
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: POSTGRES_PASSWORD
      volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data

    # RabbitMQ Message Broker
    - name: rabbitmq
      image: docker.io/library/rabbitmq:4-management-alpine
      command:
        - /bin/sh
        - -c
        - |
          # Enable OpenTelemetry plugin before starting
          echo '[rabbitmq_management,rabbitmq_prometheus,rabbitmq_opentelemetry].' > /etc/rabbitmq/enabled_plugins
          exec docker-entrypoint.sh rabbitmq-server
      ports:
        - containerPort: 5672
          hostPort: 5672
        - containerPort: 15672
          hostPort: 15672
      env:
        - name: RABBITMQ_DEFAULT_USER
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: RABBITMQ_USER
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: RABBITMQ_PASSWORD
        # OpenTelemetry configuration for RabbitMQ
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://localhost:4317"
        - name: OTEL_SERVICE_NAME
          value: "rabbitmq"
      volumeMounts:
        - name: rabbitmq-data
          mountPath: /var/lib/rabbitmq

    # MinIO Object Storage
    - name: minio
      image: docker.io/minio/minio:latest
      command: ["minio", "server", "/data", "--console-address", ":9001"]
      ports:
        - containerPort: 9000
          hostPort: 9000
        - containerPort: 9001
          hostPort: 9001
      env:
        - name: MINIO_ROOT_USER
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: MINIO_ROOT_USER
        - name: MINIO_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: MINIO_ROOT_PASSWORD
      volumeMounts:
        - name: minio-data
          mountPath: /data

    # Jaeger for distributed tracing
    - name: jaeger
      image: jaegertracing/all-in-one:1.54
      ports:
        - containerPort: 16686
          hostPort: 16686
        - containerPort: 4317
          hostPort: 4317
      env:
        - name: COLLECTOR_OTLP_ENABLED
          value: "true"

    # API Service (accessed via Traefik at /api)
    - name: api
      image: localhost/photos-index-api:latest
      ports:
        - containerPort: 5080
          # hostPort removed - access via Traefik on port 8080/api
      env:
        - name: ASPNETCORE_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: ASPNETCORE_ENVIRONMENT
        - name: ASPNETCORE_URLS
          value: "http://+:5080"
        - name: ConnectionStrings__DefaultConnection
          value: "Host=localhost;Port=5432;Database=photosindex;Username=photosuser;Password=photospass"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_ENDPOINT
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_PROTOCOL
        - name: OTEL_SERVICE_NAME
          value: "photos-index-api"
        - name: RabbitMQ__Host
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: RABBITMQ_HOST
        - name: RabbitMQ__Username
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: RABBITMQ_USER
        - name: RabbitMQ__Password
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: RABBITMQ_PASSWORD
        - name: Minio__Endpoint
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: MINIO_ENDPOINT
        - name: Minio__AccessKey
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: MINIO_ROOT_USER
        - name: Minio__SecretKey
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: MINIO_ROOT_PASSWORD
        - name: Minio__UseSsl
          value: "false"
        - name: Minio__ImagesBucket
          value: "images"
        - name: Minio__ThumbnailsBucket
          value: "thumbnails"

    # Web UI (accessed via Traefik at /)
    - name: web
      image: localhost/photos-index-web:latest
      ports:
        - containerPort: 8090
          # hostPort removed - access via Traefik on port 80
      env:
        - name: API_URL
          value: "/api"
        # Use port 8090 to avoid conflict with Traefik on port 80
        - name: NGINX_PORT
          value: "8090"

    # Indexing Service
    - name: indexing-service
      image: localhost/photos-index-indexing-service:latest
      env:
        - name: ASPNETCORE_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: ASPNETCORE_ENVIRONMENT
        - name: API_BASE_URL
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: API_BASE_URL
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_ENDPOINT
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_PROTOCOL
        - name: OTEL_SERVICE_NAME
          value: "photos-index-indexing"
        - name: PHOTOS_DIRECTORY
          value: "/photos"
        - name: INDEXING_INTERVAL_MINUTES
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: INDEXING_INTERVAL_MINUTES
        # Disable local processing - handled by distributed services (MetadataService, ThumbnailService)
        - name: GENERATE_THUMBNAILS
          value: "false"
        - name: EXTRACT_METADATA
          value: "false"
      volumeMounts:
        - name: photos
          mountPath: /photos
          readOnly: true
        - name: home-pictures
          mountPath: /scan-targets/home-pictures
          readOnly: true
        - name: thumbnails
          mountPath: /app/thumbnails

    # Cleaner Service
    - name: cleaner-service
      image: localhost/photos-index-cleaner-service:latest
      env:
        - name: ASPNETCORE_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: ASPNETCORE_ENVIRONMENT
        - name: ConnectionStrings__DefaultConnection
          value: "Host=localhost;Port=5432;Database=photosindex;Username=photosuser;Password=photospass"
        - name: API_BASE_URL
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: API_BASE_URL
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_ENDPOINT
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_PROTOCOL
        - name: OTEL_SERVICE_NAME
          value: "photos-index-cleaner"
        - name: PHOTOS_DIRECTORY
          value: "/photos"
        - name: TRASH_DIRECTORY
          value: "/photos/.trash"
        - name: CLEANER_ENABLED
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: CLEANER_ENABLED
      volumeMounts:
        - name: photos
          mountPath: /photos
        - name: cleaner-logs
          mountPath: /app/logs

    # Metadata Service (EXIF extraction)
    - name: metadata-service
      image: localhost/photos-index-metadata-service:latest
      env:
        - name: DOTNET_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: ASPNETCORE_ENVIRONMENT
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_ENDPOINT
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_PROTOCOL
        - name: OTEL_SERVICE_NAME
          value: "photos-index-metadata"
        - name: RabbitMQ__Host
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: RABBITMQ_HOST
        - name: RabbitMQ__Username
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: RABBITMQ_USER
        - name: RabbitMQ__Password
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: RABBITMQ_PASSWORD
        - name: Minio__Endpoint
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: MINIO_ENDPOINT
        - name: Minio__AccessKey
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: MINIO_ROOT_USER
        - name: Minio__SecretKey
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: MINIO_ROOT_PASSWORD
        - name: Minio__UseSsl
          value: "false"
        - name: Minio__ImagesBucket
          value: "images"

    # Thumbnail Service (Image resizing)
    - name: thumbnail-service
      image: localhost/photos-index-thumbnail-service:latest
      env:
        - name: DOTNET_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: ASPNETCORE_ENVIRONMENT
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_ENDPOINT
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: OTEL_EXPORTER_OTLP_PROTOCOL
        - name: OTEL_SERVICE_NAME
          value: "photos-index-thumbnail"
        - name: RabbitMQ__Host
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: RABBITMQ_HOST
        - name: RabbitMQ__Username
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: RABBITMQ_USER
        - name: RabbitMQ__Password
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: RABBITMQ_PASSWORD
        - name: Minio__Endpoint
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: MINIO_ENDPOINT
        - name: Minio__AccessKey
          valueFrom:
            configMapKeyRef:
              name: photos-index-config
              key: MINIO_ROOT_USER
        - name: Minio__SecretKey
          valueFrom:
            secretKeyRef:
              name: photos-index-secrets
              key: MINIO_ROOT_PASSWORD
        - name: Minio__UseSsl
          value: "false"
        - name: Minio__ImagesBucket
          value: "images"
        - name: Minio__ThumbnailsBucket
          value: "thumbnails"

  volumes:
    - name: traefik-config
      hostPath:
        path: /tmp/traefik-config
        type: Directory
    - name: postgres-data
      persistentVolumeClaim:
        claimName: postgres-pvc
    - name: rabbitmq-data
      emptyDir: {}
    - name: minio-data
      emptyDir: {}
    - name: photos
      hostPath:
        path: /tmp/photos
        type: DirectoryOrCreate
    - name: home-pictures
      hostPath:
        path: /tmp/home-pictures
        type: DirectoryOrCreate
    - name: thumbnails
      emptyDir: {}
    - name: cleaner-logs
      emptyDir: {}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
